<!DOCTYPE html>
<html>
  <head>
    <link rel="icon" href="{{ url_for('settings.get_bot_image') }}">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
    <meta http-equiv="Pragma" content="no-cache"/>
    <meta http-equiv="Expires" content="0"/>

    <title>{{ server }} - Devices</title>

    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="../static/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
  </head>

  <body>
    {% include 'includes/navbar.html' %}

    <div>
      <h1 class="h1">Devices</h1>
    </div>

    <div id="tableContainer-1">
      <div id="tableContainer-2">
        <table class="user-table" style="margin-top: 50px; width: 80%; height: auto">
          <tr>
            <th>User</th>
            <th>Device</th>
            <th>Toggle</th>
            <th>Telemetry Period</th>
            <th></th>
          </tr>
          <tbody>
            {% for user in device_data %}
                {% if device_data[user] %}
                    {% for device in device_data[user] %}
                      <tr>
                        <td>{{ user if loop.index == 1 else '' }}</td>
                        <td>{{ device['name'] }}</td>
                        <td>
                          <input type="checkbox" class="checkbox" device_id="{{ device['id'] }}" device_name="{{ device['name'] }}" {% if device.state %}checked{% endif %} onclick="toggleDevice(this)">
                        </td>
                        <td>
                          <input type="range" id="telemetry_period" name="telemetry_period" class="slider" min="30" max="300" step="30" value="{{ device['tele_period'] }}" style="width: 80px;" oninput="updateTelemetryText(this)">
                          &emsp;<b id="period_text">{{ device['tele_period'] }}</b>
                          <button id="update" class="button-81" role="button" device_id="{{ device['id'] }}" device_name="{{ device['name'] }}" style="margin-left: 10px;" onclick="updateTelemetryPeriod(this)">&#x2713;</button>
                        </td>
                        <td>
                          <button id="delete" class="button-81" role="button" device_id="{{ device['id'] }}" device_name="{{ device['name'] }}" user_firstname = "{{ user }}" style="margin-left: 10px; background-color: rgb(165, 96, 111);" onclick="deleteDevice(this)">
                            <i class="fas fa-trash-alt"></i> <!-- trash can icon -->
                          </button>
                        </td>
                      </tr>
                    {% endfor %}
                {% endif %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <br>
    <br>
    <br>

    <div>
      <h1 class="h1">Add a Device</h1>
    </div>

    <div id="tableContainer-1">
      <div id="tableContainer-2">
        <table class="user-table" style="margin-top: 50px; width: 80%; height: auto">
          <tr>
            <th>User</th>
            <th>Search
              <button id="scan" class="button-81" role="button" style="margin: 0px 0px 0px 0px; transform: scale(0.6);" onclick="scan()">
                <i class="fas fa-search"></i>
              </button>
            </th>
            <th>IP Address</th>
            <th>Name</th>
          </tr>
          <tbody>
            <tr>
              <td>
                <select id="userDropDown">
                  <!-- Use a for loop to populate the user options -->
                  {% for user in users %}
                    <option value="{{ user.id }}" first_name="{{ user.first_name }}">{{ user.first_name }}</option>
                  {% endfor %}
                </select>
              </td>
              <td>
                <select id="deviceDropDown" onclick="populateIpAddress()" onchange="populateIpAddress()">
                  <option value="--select--" selected="selected">--select--</option>
                  {% for ip in scanned_devices %}
                    <option value="{{ ip }}">{{ ip }}</option>
                  {% endfor %}
                </select>
              </td>
              <td>
                <input type="text" id="ipAddressInput" pattern="\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}" placeholder="x.x.x.x" required>
              </td>
              <td>
                <input type="text" id="nameInput" pattern="[A-Za-z]+" placeholder="Thermonuclear reactor" required>
                <span class="info" style="color: #23226B;"></span>
              </td>
            </tr>
            <tr>
              <td colspan="4">
                <button id="add" class="button-81" role="button" style="margin-left: 10px; width: 150px;" onclick="addDevice()">
                  <i class="fas fa-plus"></i>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <br>
    <br>
    <br>

    {% include 'includes/footer.html' %}

    <div id="snackbar">Update successful :O)</div>

    <script>
      function toggleDevice(checkbox) {
        // Get the device name and id from the checkbox attributes
        var device_name = checkbox.getAttribute('device_name');
        var device_id = checkbox.getAttribute('device_id');

        // Send an HTTP PUT request to the backend to toggle the device on or off
        fetch('/devices/' + device_id + '/toggle')
        .then((response) => {
          let msg = ""
          response.ok ? msg = `${device_name} toggled :O)` :
                        msg = `Failed to toggle ${device_name} :O(`
          updateSnackbar(msg, "rgb(121, 196, 137)")
        })
        .catch((error) => {
          // Handle any errors
          updateSnackbar(error, "red")
        });
      }

      function updateTelemetryPeriod(button) {
        // Get the device name, new telemetry_period,and id from the slider attributes
        var value = button.parentNode.querySelector('.slider').value;
        var device_name = button.getAttribute('device_name');
        var device_id = button.getAttribute('device_id');

        // Send an HTTP PUT request to the backend to update the device's telemetry period
        fetch('/devices/' + device_id + '/telemetry-period', {
          method: 'PUT',
          body: JSON.stringify({
            new_period: value
          }),
          headers: {
            'Content-Type': 'application/json'
          }
        })
        .then((response) => {
          let msg = ""
          response.ok ? msg = `Telemetry period updated for ${device_name} :O)` :
                        msg = `Failed to update telemetry period for ${device_name} :O(`
          updateSnackbar(msg, "rgb(121, 196, 137)")
        })
        .catch((error) => {
          // Handle any errors
          updateSnackbar(error, "red")
        });
      }

      function populateIpAddress() {
        var scanned_ip = document.getElementById("deviceDropDown").value;

        if (scanned_ip != "--select--") {
          document.getElementById("ipAddressInput").value = scanned_ip;
        }
      }

      function addDevice() {
        document.body.style.cursor = 'wait';

        // Get the values from the input boxes
        var userDropDown = document.getElementById("userDropDown");
        var user_id = userDropDown.value;
        var user_firstname = userDropDown.options[userDropDown.selectedIndex].getAttribute("first_name");
        var ipAddress = document.getElementById("ipAddressInput").value;
        var name = document.getElementById("nameInput").value;

        // Send an HTTP PUT request to the backend to add the device for the user
        fetch('/devices/add', {
          method: 'PUT',
          body: JSON.stringify({
            user_id: user_id,
            ip_address: ipAddress,
            device_name: name,
            user_firstname: user_firstname
          }),
          headers: {
            'Content-Type': 'application/json'
          }
        })
        .then((response) => {
          if (response.ok) {
            return response.json();
          }
          return response.json().then(data => {
            throw new Error(data.error);
          });
        })
        .then(data => {
          if (data.success) {
            const msg = data.success;
            localStorage.setItem('deviceAddMessage', msg);
            location.reload();
          }
        })
        .catch((error) => {
          // Clear the input boxes
          document.getElementById("ipAddressInput").value = "";
          document.getElementById("nameInput").value = "";

          document.body.style.cursor = 'default';
          updateSnackbar(error, "red")
        })
        .finally(() => {
          document.body.style.cursor = 'default';
        });
      }

      function deleteDevice(button) {
        var device_id = button.getAttribute('device_id');
        var device_name = button.getAttribute('device_name');
        var user_firstname = button.getAttribute('user_firstname')

        // Send an HTTP PUT request to the backend to delete the device for the user
        fetch('/devices/delete', {
          method: 'PUT',
          body: JSON.stringify({
            device_id: device_id,
            user_firstname: user_firstname
          }),
          headers: {
            'Content-Type': 'application/json'
          }
        })
        .then((response) => {
          if (response.ok) {
            return response.json();
          }
          msg = `Failed to delete ${device_name} for ${user_firstname} :O(`
          throw new Error(msg);
        })
        .then((data) => {
          if (data.success) {
            const msg = data.success;
            localStorage.setItem('deviceDeleteMessage', msg);
            location.reload();
          }
        })
        .catch((error) => {
          updateSnackbar(error, "red")
        });
      }

      function scan() {
        document.getElementById("scan").disabled = true;
        document.body.style.cursor = 'wait';

        $.getJSON("/devices/scan", function(response){
          if (!response.error) {
            var dropdown = $("#deviceDropDown");
            dropdown.empty();

            $.each(response, function(key, value) {
              dropdown.append($("<option></option>").attr("value", value).text(value));
            });
            populateIpAddress();

          } else {
            updateSnackbar(response.error, "coral")
          }

          document.body.style.cursor = 'default';
          document.getElementById("scan").disabled = false;
        });
      }

      // After page is refreshed show device snackbar info
      window.onload = function() {
        const deviceAddMessage = localStorage.getItem('deviceAddMessage');
        const deviceDeleteMessage = localStorage.getItem('deviceDeleteMessage');

        if (deviceAddMessage) {
          updateSnackbar(deviceAddMessage, "rgb(121, 196, 137)");
          localStorage.removeItem('deviceAddMessage');
        } else if (deviceDeleteMessage) {
          updateSnackbar(deviceDeleteMessage, "rgb(121, 196, 137)");
          localStorage.removeItem('deviceDeleteMessage');
        }
      };

      function updateSnackbar(message, color) {
        var x = document.getElementById("snackbar");
        x.innerHTML = message

        x.style.backgroundColor = color;

        // Add the "show" class to DIV
        x.className = "show";

        // After 3 seconds, remove the show class from DIV
        setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
      }

      function updateTelemetryText(slider) {
        var telem_text = slider.nextElementSibling;
        telem_text.innerHTML = slider.value;

        slider.oninput = function() {
          telem_text.innerHTML = this.value;
        }
      }
    </script>

  </body>
</html>
