<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
    <meta http-equiv="Pragma" content="no-cache"/>
    <meta http-equiv="Expires" content="0"/>

    <title>SeamNet - Devices</title>

    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="../static/styles.css">
  </head>

  <body>
    <div id="navbar"></div>

    <div>
      <h1 class="h1">Devices</h1>
    </div>

    <div id="tableContainer-1">
      <div id="tableContainer-2">
        <table class="user-table" style="margin-top: 50px; width: 80%; height: auto">
          <tr>
            <th>User</th>
            <th>Device</th>
            <th>Toggle</th>
            <th>Telemetry Period</th>
          </tr>
          <tbody>
            {% for user in device_data %}
              <tr>
                <td>{{ user }}</td>
                <td>
                  <div id="tableContainer-1">
                    <div id="tableContainer-2">
                      <table class="user-table" id="tableContainer-1-small">
                        <tbody>
                          {% for device in device_data[user] %}
                            <tr>
                              <td>{{ device['name'] }}</td>
                            </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </td>
                <td>
                  <div id="tableContainer-1">
                    <div id="tableContainer-2">
                      <table class="user-table" id="tableContainer-1-small">
                        <tbody>
                          {% for device in device_data[user] %}
                            <tr>
                              <td>
                                <input type="checkbox" class="checkbox" device_id="{{ device['id'] }}" device_name="{{ device['name'] }}" {% if device.state %}checked{% endif %} onclick="toggleDevice(this)">
                              </td>
                            </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </td>
                <td>
                  <div id="tableContainer-1">
                    <div id="tableContainer-2">
                      <table class="user-table" id="tableContainer-1-small">
                        <tbody>
                          {% for device in device_data[user] %}
                            <tr>
                              <td>
                                <input type="range" id="telemetry_period" name="telemetry_period" class="slider" min="30" max="300" step="30" value="{{ device['tele_period'] }}" style="width: 80px;" oninput="updateTelemetryText(this)">
                                &emsp;<b id="period_text">{{ device['tele_period'] }}</b>
                                <button id="update" class="button-81" role="button" device_id="{{ device['id'] }}" device_name="{{ device['name'] }}" style="margin-left: 20px;" onclick="updateTelemetryPeriod(this)">&#x2713;</button>
                              </td>
                            </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <br>
    <br>
    <br>

    <div id="footer"></div>

    <script>
      // Load header and footer on page load
      $(function(){
          $("#navbar").load("/static/navbar.html");
          $("#footer").load("/static/footer.html");
        });
    </script>

    <div id="snackbar">Update successful :O)</div>

    <script>
      function toggleDevice(checkbox) {
        // Get the device name and id from the checkbox attributes
        var device_name = checkbox.getAttribute('device_name');
        var device_id = checkbox.getAttribute('device_id');

        // Send an HTTP PUT request to the backend to toggle the device on or off
        fetch('/devices/' + device_id + '/toggle')
        .then((response) => {
          let msg = ""
          response.ok ? msg = `${device_name} toggled :O)` :
                        msg = `Failed to toggle ${device_name} :O(`
          updateSnackbar(msg, "rgb(121, 196, 137)")
        })
        .catch((error) => {
          // Handle any errors
          updateSnackbar(error, "red")
        });
      }

      function updateTelemetryPeriod(button) {
        // Get the device name, new telemetry_period,and id from the slider attributes
        var value = button.parentNode.querySelector('.slider').value;
        var device_name = button.getAttribute('device_name');
        var device_id = button.getAttribute('device_id');

        // Send an HTTP PUT request to the backend to update the device's telemetry period
        fetch('/devices/' + device_id + '/telemetry-period', {
          method: 'PUT',
          body: JSON.stringify({
            new_period: value
          }),
          headers: {
            'Content-Type': 'application/json'
          }
        })
        .then((response) => {
          let msg = ""
          response.ok ? msg = `Telemetry period updated for ${device_name} :O)` :
                        msg = `Failed to update telemetry period for ${device_name} :O(`
          updateSnackbar(msg, "rgb(121, 196, 137)")
        })
        .catch((error) => {
          // Handle any errors
          updateSnackbar(error, "red")
        });
      }

      function updateSnackbar(message, color) {
        var x = document.getElementById("snackbar");
        x.innerHTML = message

        x.style.backgroundColor = color;

        // Add the "show" class to DIV
        x.className = "show";

        // After 3 seconds, remove the show class from DIV
        setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
      }

      function updateTelemetryText(slider) {
        var telem_text = slider.nextElementSibling;
        telem_text.innerHTML = slider.value;

        slider.oninput = function() {
          telem_text.innerHTML = this.value;
        }
      }
    </script>

  </body>
</html>
